<!DOCTYPE html>
<html
  lang="en"
  th:replace="~{base :: parent(~{::#content},~{::title}, ~{::script})}"
>
  <head>
    <title>Trimly - URL Shortener</title>
  </head>
  <body>
    <section id="content">
      <div th:replace="~{components :: alertBox}"></div>
      <!-- URL Shortener Section -->
      <div class="container">
        <div class="url-shortener">
          <h2>Shorten Your URL</h2>
          <form
            action="/shorten"
            th:object="${linkRequestDto}"
            method="POST"
            novalidate
          >
            <div class="input-group">
              <input
                type="text"
                id="shorten"
                th:field="*{longUrl}"
                placeholder="Enter URL Here"
                required
              />

              <button type="submit">Shorten</button>
              <div class="pl-5">
                <!-- Error message container for longUrl -->
                <p class="error" id="longUrlError"></p>
              </div>
            </div>

            <div th:if="${authenticated}">
              <div class="switch">
                <label for="extraDetailsCheck">Add extra details :</label>
                <label>
                  <input
                    type="checkbox"
                    class="checkbox"
                    id="extraDetailsCheck"
                    value="true"
                  />
                  <div class="slider"></div>
                </label>
              </div>

              <!-- if above checkbox is checked -->
              <div id="extraDetails" style="display: none">
                <div class="input-group">
                  <input
                    class="extraDetailsForm"
                    type="text"
                    th:field="*{title}"
                    placeholder="Enter link title here."
                  />
                </div>

                <div class="switch">
                  <label for="protectLinkCheck"
                    >Protect Link :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;
                    &nbsp;</label
                  >
                  <label>
                    <input
                      type="checkbox"
                      class="checkbox"
                      id="protectLinkCheck"
                      value="true"
                    />
                    <div class="slider"></div>
                  </label>
                </div>
                <!-- Allow Password if Above checkbox is checked.  -->

                <div
                  class="password-fields"
                  id="protectLink"
                  style="display: none"
                >
                  <div class="input-group">
                    <input
                      class="extraDetailsForm"
                      type="password"
                      th:field="*{password}"
                      id="password"
                      placeholder="Enter Password"
                      required
                    />
                    <div class="pl-5">
                      <!-- Error message container for password -->
                      <p class="error" id="passwordError"></p>
                    </div>
                  </div>

                  <div class="input-group">
                    <input
                      class="extraDetailsForm"
                      type="password"
                      th:field="*{confirmPassword}"
                      id="confirmPassword"
                      placeholder="Confirm Password"
                      required
                    />

                    <div class="pl-5">
                      <!-- Error message container for confirmPassword -->
                      <p class="error" id="passwordError" style="display: none">
                        Passwords do not match.
                      </p>
                      <p class="error" id="matchPasswordError"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Single Table for Features -->
      <div class="card-container" th:if="!${authenticated}">
        <h3>Benefits of Using Trimly</h3>
        <table>
          <thead>
            <tr>
              <th>Feature</th>
              <th>Non-Registered Users</th>
              <th>Registered Users</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Shorten any URL easily</td>
              <td class="check">✔</td>
              <td class="check">✔</td>
            </tr>
            <tr>
              <td>Save time while sharing</td>
              <td class="check">✔</td>
              <td class="check">✔</td>
            </tr>
            <tr>
              <td>Lifetime saved shortened URLs</td>
              <td class="cross">✘</td>
              <td class="check">✔</td>
            </tr>
            <tr>
              <td>View link statistics</td>
              <td class="cross">✘</td>
              <td class="check">✔</td>
            </tr>
            <tr>
              <td>Manage your links</td>
              <td class="cross">✘</td>
              <td class="check">✔</td>
            </tr>
          </tbody>
        </table>
        <div style="text-align: center; margin-top: 20px">
          <a href="/sign-up">
            <button><i class="fas fa-user-plus"></i> Sign Up</button>
          </a>
        </div>
      </div>
    </section>

    <script>
      document
        .querySelector("form")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent the default form submission
          const form = event.target;
          let formData = new FormData(this); // Collect form data

          fetch(form.action, {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                // Display success message with SweetAlert
                Swal.fire({
                  icon: "success",
                  title: data.message,
                  text: `Your shortened URL is: ${data.shortUrl}`,
                }).then(() => {
                  // After SweetAlert closes, reset the form
                  document.querySelector("form").reset(); // Clear all form fields
                });
              } else {
                // Handle validation errors
                if (data.errors) {
                  document
                    .querySelectorAll(".error")
                    .forEach((e) => (e.innerHTML = ""));

                  // Display errors for each field
                  Object.keys(data.errors).forEach((field) => {
                    let errorMessage = data.errors[field];
                    let errorElement = document.querySelector(`#${field}Error`);
                    if (errorElement) {
                      errorElement.innerHTML = errorMessage;
                    }
                  });
                }
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              Swal.fire({
                icon: "error",
                title: "Something went wrong!",
                text: "Please try again later.",
              });
            });
        });

      document
        .getElementById("extraDetailsCheck")
        .addEventListener("change", function () {
          const extraDetails = document.querySelector("#extraDetails");
          if (this.checked) {
            extraDetails.style.display = "block";
          } else {
            extraDetails.style.display = "none";
          }
        });

      document
        .getElementById("protectLinkCheck")
        .addEventListener("change", function () {
          const protectLink = document.querySelector("#protectLink");
          if (this.checked) {
            protectLink.style.display = "block";
          } else {
            protectLink.style.display = "none";
          }
        });
    </script>
  </body>
</html>
